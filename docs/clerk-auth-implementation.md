# Clerk Authentication with shadcn/ui Implementation Guide

## Overview
This document provides step-by-step instructions for implementing Clerk authentication in a Next.js application using shadcn/ui components. This guide follows best practices and uses the shadcn CLI for component installation.

## Prerequisites
- Next.js 13+ with App Router
- shadcn/ui configured
- Clerk account with API keys

## Implementation Steps

### 1. Install Clerk Dependencies

```bash
npm install @clerk/nextjs
```

### 2. Environment Configuration

Create a `.env.local` file in the project root:

```env
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_***
CLERK_SECRET_KEY=sk_test_***
```

Replace the placeholder keys with actual keys from your Clerk dashboard.

### 3. Middleware Setup

Create `middleware.ts` in the project root:

```typescript
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server'

// Define protected routes (you can customize these patterns)
const isProtectedRoute = createRouteMatcher([
  '/dashboard(.*)',
  '/profile(.*)',
])

export default clerkMiddleware((auth, req) => {
  if (isProtectedRoute(req)) {
    auth().protect()
  }
})

export const config = {
  matcher: [
    // Skip Next.js internals and static files
    '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
    // Always run for API routes
    '/(api|trpc)(.*)',
  ],
}
```

### 4. Add shadcn/ui Components Using CLI

```bash
npx shadcn@latest add button
npx shadcn@latest add card
npx shadcn@latest add avatar
npx shadcn@latest add dropdown-menu
npx shadcn@latest add skeleton
```

### 5. Update Root Layout

Modify `src/app/layout.tsx` to include ClerkProvider:

```typescript
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { ClerkProvider } from '@clerk/nextjs'
import StoreProvider from "@/redux/providers/StoreProvider";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body
          className={`${geistSans.variable} ${geistMono.variable} antialiased min-h-screen flex flex-col`}
        >
          <StoreProvider>
            {children}
          </StoreProvider>
        </body>
      </html>
    </ClerkProvider>
  );
}
```

### 6. Create Auth Components

Create `src/components/auth/SignInButton.tsx`:

```typescript
'use client'

import { SignInButton as ClerkSignInButton } from '@clerk/nextjs'
import { Button } from '@/components/ui/button'

export default function SignInButton({
  children,
  ...props
}: React.ComponentProps<typeof ClerkSignInButton>) {
  return (
    <ClerkSignInButton {...props}>
      {children || (
        <Button variant="default">
          Sign In
        </Button>
      )}
    </ClerkSignInButton>
  )
}
```

Create `src/components/auth/SignOutButton.tsx`:

```typescript
'use client'

import { SignOutButton as ClerkSignOutButton } from '@clerk/nextjs'
import { Button } from '@/components/ui/button'

export default function SignOutButton({
  children,
  ...props
}: React.ComponentProps<typeof ClerkSignOutButton>) {
  return (
    <ClerkSignOutButton {...props}>
      {children || (
        <Button variant="destructive">
          Sign Out
        </Button>
      )}
    </ClerkSignOutButton>
  )
}
```

Create `src/components/auth/UserProfileButton.tsx`:

```typescript
'use client'

import { useUser } from '@clerk/nextjs'
import { UserButton } from '@clerk/nextjs'
import { Button } from '@/components/ui/button'
import { Skeleton } from '@/components/ui/skeleton'

export default function UserProfileButton() {
  const { isLoaded, isSignedIn } = useUser()

  if (!isLoaded) {
    return <Skeleton className="w-8 h-8 rounded-full" />
  }

  if (!isSignedIn) {
    return null
  }

  return (
    <UserButton 
      appearance={{
        elements: {
          avatarBox: 'w-8 h-8'
        }
      }}
    />
  )
}
```

### 7. Create Header Component

Create `src/components/Header.tsx`:

```typescript
'use client'

import { useUser } from '@clerk/nextjs'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Skeleton } from '@/components/ui/skeleton'
import SignInButton from '@/components/auth/SignInButton'
import UserProfileButton from '@/components/auth/UserProfileButton'

export default function Header() {
  const { isLoaded, isSignedIn } = useUser()

  return (
    <header className="border-b">
      <div className="container flex h-16 items-center justify-between px-4">
        <div className="flex items-center gap-6">
          <Link href="/" className="text-xl font-bold">
            MyApp
          </Link>
          <nav className="hidden md:flex items-center gap-6 text-sm font-medium">
            <Link href="/" className="transition-colors hover:text-foreground/80">
              Home
            </Link>
            {isSignedIn && (
              <Link 
                href="/dashboard" 
                className="transition-colors hover:text-foreground/80"
              >
                Dashboard
              </Link>
            )}
          </nav>
        </div>
        
        <div className="flex items-center gap-2">
          {!isLoaded ? (
            <Skeleton className="w-8 h-8 rounded-full" />
          ) : isSignedIn ? (
            <UserProfileButton />
          ) : (
            <SignInButton />
          )}
        </div>
      </div>
    </header>
  )
}
```

### 8. Update Layout with Header

Update `src/app/layout.tsx` to include the header:

```typescript
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { ClerkProvider } from '@clerk/nextjs'
import StoreProvider from "@/redux/providers/StoreProvider";
import Header from "@/components/Header";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body
          className={`${geistSans.variable} ${geistMono.variable} antialiased min-h-screen flex flex-col`}
        >
          <StoreProvider>
            <Header />
            <main className="flex-grow">
              {children}
            </main>
          </StoreProvider>
        </body>
      </html>
    </ClerkProvider>
  );
}
```

### 9. Create Protected Page Example

Create `src/app/dashboard/page.tsx`:

```typescript
'use client'

import { useUser } from '@clerk/nextjs'
import { SignInButton, SignOutButton } from '@/components/auth'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Skeleton } from '@/components/ui/skeleton'
import Link from 'next/link'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'

export default function Dashboard() {
  const { isLoaded, isSignedIn, user } = useUser()

  if (!isLoaded) {
    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        <div className="w-full max-w-md space-y-4">
          <Skeleton className="h-12 w-3/4 mx-auto" />
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-2/3 mx-auto" />
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen p-4 md:p-8">
      <div className="max-w-4xl mx-auto space-y-8">
        <div className="flex justify-between items-center">
          <h1 className="text-3xl font-bold">Dashboard</h1>
          {isSignedIn ? (
            <SignOutButton>
              <Button variant="destructive">Sign Out</Button>
            </SignOutButton>
          ) : (
            <SignInButton>
              <Button>Sign In</Button>
            </SignInButton>
          )}
        </div>
        
        {isSignedIn ? (
          <div className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Welcome, {user?.firstName}!</CardTitle>
                <CardDescription>Your account information</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="flex items-center space-x-4">
                  <Avatar className="w-16 h-16">
                    <AvatarImage src={user?.imageUrl} alt="User profile" />
                    <AvatarFallback>
                      {user?.firstName?.charAt(0)}
                      {user?.lastName?.charAt(0)}
                    </AvatarFallback>
                  </Avatar>
                  <div>
                    <p className="font-medium">
                      {user?.firstName} {user?.lastName}
                    </p>
                    <p className="text-sm text-muted-foreground">
                      {user?.emailAddresses[0]?.emailAddress}
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Navigation</CardTitle>
                <CardDescription>Explore your application</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="flex flex-wrap gap-2">
                  <Link href="/">
                    <Button variant="outline">Home</Button>
                  </Link>
                  <Link href="/dashboard">
                    <Button variant="outline">Dashboard</Button>
                  </Link>
                </div>
              </CardContent>
            </Card>
          </div>
        ) : (
          <Card>
            <CardHeader>
              <CardTitle>Access Restricted</CardTitle>
              <CardDescription>You need to be signed in to view this page</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="text-center py-8">
                <p className="mb-6 text-muted-foreground">
                  Please sign in to access your dashboard
                </p>
                <SignInButton mode="modal">
                  <Button>Sign In</Button>
                </SignInButton>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  )
}
```

### 10. Create Auth Helpers

Create `src/lib/auth-helpers.ts`:

```typescript
import { auth } from '@clerk/nextjs/server'
import { redirect } from 'next/navigation'

// Helper to protect server components
export function protectRoute() {
  const { userId } = auth()
  
  if (!userId) {
    redirect('/sign-in')
  }
  
  return { userId }
}

// Helper to redirect authenticated users
export function redirectIfAuthenticated(redirectPath: string = '/dashboard') {
  const { userId } = auth()
  
  if (userId) {
    redirect(redirectPath)
  }
}
```

## Best Practices

1. **Environment Variables**: Store Clerk keys securely in `.env.local`
2. **Route Protection**: Use `createRouteMatcher` for flexible route protection
3. **Client/Server Separation**: 
   - Use `useUser` hook for client-side auth state
   - Use `auth()` function for server-side protection
4. **Performance**: 
   - Leverage Clerk's built-in caching mechanisms
   - Use shadcn CLI to install components
5. **Type Safety**: Maintain strong typing throughout
6. **UI Components**: Use shadcn/ui components for consistent design
7. **Loading States**: Handle loading states with Skeleton components
8. **Accessibility**: shadcn/ui components are accessible by default

## Usage Examples

### Accessing Auth State in Client Components

```typescript
'use client'

import { useUser } from '@clerk/nextjs'
import { Button } from '@/components/ui/button'

export default function UserProfile() {
  const { isLoaded, isSignedIn, user } = useUser()
  
  if (!isLoaded) return <div>Loading...</div>
  if (!isSignedIn) return <Button variant="default">Please sign in</Button>
  
  return <div>Welcome, {user?.firstName}!</div>
}
```

### Protecting Server Components

```typescript
// In a server component
import { protectRoute } from '@/lib/auth-helpers'

export default function ProtectedPage() {
  const { userId } = protectRoute()
  
  return <div>Protected content for user {userId}</div>
}
```